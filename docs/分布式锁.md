# 分布式锁

1.13.基于Redis的分布式锁

数据库锁是基于单个数据库实现的，在我们的业务跨多个数据库时，就要使用分布式锁来保证数据的一致性。下面介绍使用Redis实现一个分布式锁的流程。Redis实现的分布式锁以Redis setnx命令为中心实现，setnx是Redis的写入操作命令，具体语法为setnx(key val)。在且仅在key不存在时，则插入一个key为val的字符串，返回1；若key存在，则什么都不做，返回0。通过setnx实现分布式锁的思路如下。

- 获取锁：在获取锁时调用setnx，如果返回0，则该锁正在被别人使用；如果返回1，则成功获取锁。
- 释放锁：在释放锁时，判断锁是否存在，如果存在，则执行Redis的delete操作释放锁。

```
public class RedisLock{
	private final static Log logger=LogFactory.getLog(BuilderDemo.class);
	private Jedis jedis;
	public RedisLock(Jedis jedi){
		this.jedis=jedis;
	}
	//获取锁
	public synchronized boolean lock(String lockId){
		//设置锁
		Long status=jedis.setnx(lockId,currentTimeMillis+“”)；
		if(0==status){//有人在使用该锁，获取锁失败
			return false;
		}else{
			return true;//创建获取锁成功，锁id=lockId
		}
	}
	//释放锁
	public synchronized boolean unlock(String lockId){
		String lockValue=jedis.get(lockId);
		if(lockValue!=null){//释放锁成功
			jedis.del(lockId);
			return true;
		}else{
			return false;//释放锁失败
		}
	}
}
```

以上代码定义了RedisLock类，在该类中定义了一个Redis数据库连接Jedis，同时定义了lock方法来获取一个锁，在获取锁时首先通过setnx设置锁id获取Redis内锁的信息，如果返回信息为 0，则表示锁正在被人使用（锁id存在于Redis中）；如果不为 0，则表示成功在内存中设置了该锁。同时在RedisLock类中定义了unlock方法用于释放一个锁，具体做法是在Redis中查找该锁并删除。